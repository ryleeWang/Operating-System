# 系统启动

## 基本概念

### BIOS

BIOS是固化到计算机主板上的程序。

**BIOS启动：**系统CPU在完成初始化之后处于实模式下（此时CPU为16位，地址空间为20位，`内存地址=段基址:段内偏移地址`即`内存地址=代码段寄存器(CS)左移4位+指令指针寄存器(IP)`）。约定在系统启动时，代码段寄存器和指令指针寄存器的值分别为0xf000和0xfff0，且由于实模式下地址空间为20位，最大寻址空间为1MB。0xf000:fff0处的指令是一条`JUMP START`指令，跳转到真正的BIOS程序入口地址，开始运行BIOS。

_启动时的内存布局：_

| 空闲空间（保留内存） | BIOS | 空闲空间 |
| :--- | :--- | :--- |
| 0~640KB | 640KB~1MB | 1MB~ |

### UEFI

统一可扩展固件接口（UEFI）是一种新的启动规范，目标是在所有平台上提供一致的操作系统启动服务。UEFI定义了一种可信启动流程，只有满足签名的引导记录才能被读取，在启动阶段减少安全风险。

### 加载程序（bootloader）

BIOS程序将加载程序（bootloader）加载到0x7c00，程序跳转到0x0000:7c00执行。加载程序能够识别文件系统的格式，采用相应的格式加载操作系统代码。然后加载程序将操作系统的代码和数据（内核映像）读取到内存中，并跳转到操作系统的起始地址。

**加载程序读取的细化：**现代操作系统的文件系统分为不同的分区，BIOS读取主引导扇区代码，根据主引导记录决定到哪一个分区（活动分区）去读取加载程序。主引导扇区代码读取活动分区的引导扇区代码，由这个引导扇区代码读取文件系统的加载程序，最终读取指定的内核映像。

_主引导记录MBR格式：_

| 名称 | 大小 | 作用 |
| :--- | :--- | :--- |
| 启动代码 | 446字节 | 检查分区表的正确性；加载并跳转到活动分区的引导记录 |
| 硬盘分区表 | 64字节 | 描述分区状态和位置，每个分区描述信息占16字节 |
| 结束标志字 | 2字节 | 主引导记录的有效标志，关乎主引导记录是否合法（指定值为0x55AA） |

_分区引导扇区格式：_

| 名称 | 作用 |
| :--- | :--- |
| 跳转指令 | 一条跳转指令，跳转到启动代码，根据CPU不同而改变 |
| 文件卷头 | 文件系统描述信息 |
| 启动代码 | 跳转到加载程序 |
| 结束标志字 | 与主引导记录的结束标志字作用相同（0x55AA） |

## 启动流程

1. CPU初始化：CPU加电稳定后从0xf000:fff0读取第一条指令，根据该条指令跳转到BIOS程序入口

   `CS=0xf000`，`IP=0Xfff0`，`CS:IP=0xf000fff0`，`PC=16*CS+IP=0Xffff0`。

2. BIOS初始化：硬件自检（POST）、执行系统BIOS（系统自检）、读取加载程序
   1. 硬件自检（POST）：检测系统中内存、显卡等部件是否工作以及工作状态；执行设备自己的BIOS对设备进行初始化；
   2. 执行系统BIOS：系统自检（检测和配置系统中安装的即插即用设备）、更新CMOS中的扩展系统配置数据（ESCD）

      `ESCD: 扩展系统配置数据（系统配置表），根据ESCD能知道当前系统里有些什么设备`

   3. 按在BIOS中指定的顺序从软盘、硬盘或光驱读取第一个扇区，将控制权交到从外部读入的代码。
3. 加载程序（bootloader）
   1. 从文件系统中读取启动配置信息
   2. 选择不同的操作系统内核和加载参数
   3. 依据配置加载指定的内核，并转到内核执行

